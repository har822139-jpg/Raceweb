<!DOCTYPE html>
<html>
<head>
    <title>Raceweb</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; background: #000; color: #fff; margin: 0; padding: 10px; }
        .header { color: #ff3e3e; font-size: 20px; font-weight: bold; margin: 10px 0; }
        .main-box { background: #1a1a1a; border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 2px solid #333; }
        #speed { font-size: 100px; font-weight: 900; color: #00ff00; line-height: 1; margin: 10px 0; }
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; }
        .mode-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #aaa; border-radius: 5px; font-size: 12px; }
        .active-mode { background: #ff3e3e !important; color: #fff !important; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .card { background: #252525; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .label { font-size: 11px; color: #aaa; text-transform: uppercase; }
        .value { font-size: 24px; font-weight: bold; color: #ffeb3b; }
        button.main-btn { width: 100%; padding: 15px; background: #444; color: white; border: none; border-radius: 10px; margin: 10px 0; font-weight: bold; font-size: 16px; }
        .history-section { margin-top: 20px; text-align: left; background: #111; padding: 10px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { border-bottom: 1px solid #444; padding: 8px; color: #ff3e3e; }
        td { padding: 8px; border-bottom: 1px solid #222; text-align: center; }
    </style>
</head>
<body>

    <div class="header">RACEWEB</div>
    
    <div class="mode-selector">
        <button id="btn201" class="mode-btn active-mode" onclick="setMode(201)">MODE 201M</button>
        <button id="btn402" class="mode-btn" onclick="setMode(402)">MODE 402M</button>
    </div>

    <div class="main-box">
        <div id="status" style="color: #00fbff; font-size: 14px; font-weight: bold;">READY - STANDBY</div>
        <div id="speed">0</div>
        <div class="label">KM / JAM</div>
    </div>

    <div class="grid">
        <div class="card"><div class="label">Jarak (m)</div><div id="dist" class="value">0.0</div></div>
        <div class="card"><div class="label">Timer (s)</div><div id="timer" class="value">0.00</div></div>
    </div>

    <button class="main-btn" onclick="resetLogic()">CALIBRATE</button>

    <div class="history-section">
        <div style="font-weight: bold; margin-bottom: 10px;">RIWAYAT TERAKHIR</div>
        <table>
            <thead><tr><th>Jam</th><th>Jarak</th><th>Waktu</th></tr></thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <script>
        let startTime, timerInterval, startCoords = null;
        let running = false, targetDist = 201;

        window.onload = displayHistory;

        function setMode(dist) {
            targetDist = dist;
            document.getElementById('btn201').className = (dist == 201) ? 'mode-btn active-mode' : 'mode-btn';
            document.getElementById('btn402').className = (dist == 402) ? 'mode-btn active-mode' : 'mode-btn';
            resetLogic();
        }

        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition((pos) => {
                let speed = (pos.coords.speed || 0) * 3.6;
                let lat = pos.coords.latitude;
                let lon = pos.coords.longitude;
                document.getElementById("speed").innerText = Math.round(speed);

                // Auto Start
                if (speed > 1.5 && !running) {
                    running = true;
                    startTime = Date.now();
                    startCoords = { lat, lon };
                    document.getElementById("status").innerText = "RACING " + targetDist + "M...";
                    document.getElementById("status").style.color = "#ff3e3e";
                    timerInterval = setInterval(() => {
                        document.getElementById("timer").innerText = ((Date.now() - startTime) / 1000).toFixed(2);
                    }, 50);
                }

                if (running) {
                    let d = calculateDistance(startCoords.lat, startCoords.lon, lat, lon);
                    document.getElementById("dist").innerText = d.toFixed(1);

                    // AUTO STOP & SAVE
                    if (d >= targetDist) {
                        let finalTime = ((Date.now() - startTime) / 1000).toFixed(2);
                        stopAndSave(finalTime);
                    }
                }
            }, null, { enableHighAccuracy: true, maximumAge: 0 });
        }

        function stopAndSave(finalTime) {
            running = false;
            clearInterval(timerInterval);
            document.getElementById("status").innerText = "FINISHED!";
            document.getElementById("status").style.color = "#4caf50";
            
            let history = JSON.parse(localStorage.getItem("raceLog") || "[]");
            let now = new Date();
            let timeStr = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
            history.unshift({ jam: timeStr, dist: targetDist + "m", hasil: finalTime + "s" });
            localStorage.setItem("raceLog", JSON.stringify(history.slice(0, 10)));
            displayHistory();
        }

        function resetLogic() {
            clearInterval(timerInterval);
            running = false;
            document.getElementById("timer").innerText = "0.00";
            document.getElementById("dist").innerText = "0.0";
            document.getElementById("status").innerText = "READY - STANDBY";
            document.getElementById("status").style.color = "#00fbff";
        }

        function displayHistory() {
            let history = JSON.parse(localStorage.getItem("raceLog") || "[]");
            document.getElementById("historyBody").innerHTML = history.map(item => `
                <tr><td>${item.jam}</td><td>${item.dist}</td><td>${item.hasil}</td></tr>
            `).join("");
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
